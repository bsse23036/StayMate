-- 1. Create specific types for Roles to prevent typos
CREATE TYPE user_role AS ENUM ('student', 'hostel_owner', 'mess_owner');

-- 2. The Main Users Table
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    full_name VARCHAR(100) NOT NULL,
    email VARCHAR(150) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL, -- Store hashed passwords, never plain text!
    phone_number VARCHAR(20),
    role user_role NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 3. The Hostel Buildings
CREATE TABLE hostels (
    hostel_id SERIAL PRIMARY KEY,
    owner_id INT REFERENCES users(user_id) ON DELETE CASCADE, -- Links to the Owner
    name VARCHAR(100) NOT NULL,
    city VARCHAR(50) NOT NULL, -- e.g., 'Lahore', 'Sheikhupura'
    address TEXT NOT NULL,
    description TEXT,
    main_image_url TEXT, -- Link to S3 Image
    wifi_available BOOLEAN DEFAULT FALSE,
    generator_available BOOLEAN DEFAULT FALSE
);

-- 4. The Rooms inside the Hostels
CREATE TABLE rooms (
    room_id SERIAL PRIMARY KEY,
    hostel_id INT REFERENCES hostels(hostel_id) ON DELETE CASCADE,
    room_type VARCHAR(50), -- e.g., '1 Seater', '2 Seater', 'Shared'
    price_per_month DECIMAL(10, 2) NOT NULL,
    total_beds INT NOT NULL,
    available_beds INT NOT NULL, -- This decreases when booked
    has_attached_bath BOOLEAN DEFAULT TRUE
);

-- 5. The Mess Services
CREATE TABLE mess_services (
    mess_id SERIAL PRIMARY KEY,
    owner_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    city VARCHAR(50) NOT NULL,
    monthly_price DECIMAL(10, 2) NOT NULL,
    delivery_radius_km DECIMAL(4, 1) -- e.g., 2.5 km
);

-- 6. The Weekly Menu (e.g., Monday: Biryani)
CREATE TABLE mess_menus (
    menu_id SERIAL PRIMARY KEY,
    mess_id INT REFERENCES mess_services(mess_id) ON DELETE CASCADE,
    day_of_week VARCHAR(15) NOT NULL, -- 'Monday', 'Tuesday'
    breakfast_item VARCHAR(100),
    lunch_item VARCHAR(100),
    dinner_item VARCHAR(100)
);

-- 7. Room Bookings
CREATE TABLE room_bookings (
    booking_id SERIAL PRIMARY KEY,
    student_id INT REFERENCES users(user_id),
    room_id INT REFERENCES rooms(room_id),
    start_date DATE NOT NULL,
    status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'confirmed', 'rejected'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 8. Mess Subscriptions
CREATE TABLE mess_subscriptions (
    subscription_id SERIAL PRIMARY KEY,
    student_id INT REFERENCES users(user_id),
    mess_id INT REFERENCES mess_services(mess_id),
    start_date DATE NOT NULL,
    is_active BOOLEAN DEFAULT TRUE
);